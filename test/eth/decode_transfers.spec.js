const assert = require('assert');
const { decodeTransferTrace } = require('../../blockchains/eth/lib/decode_transfers');
const Web3 = require('web3');
const Web3Wrapper = require('../../blockchains/eth/lib/web3_wrapper');
const constants =  require('../../blockchains/eth/lib/constants');


describe('genesis transfers', function() {
  let web3Wrapper = null;
  let web3 = null;

  beforeEach(async function() {
    web3 = new Web3(new Web3.providers.HttpProvider(constants.NODE_URL));
    web3Wrapper = new Web3Wrapper(web3);
  });

  it('parses trace of type suicide', function() {
      const suicide_trace =  {
      'action': {
        'address': '0xa6c3b7f6520a0ef594fc666d3874ec78c561cdbb',
        'balance': '0x2386f26fc100000',
        'refundAddress': '0x245133ea0fb1b77fab5886d7ffb8046dfeff3858'
      },
      'blockHash': '0x9aaaed9f94c47b3d7dba12743b50f6de750edd18d4019b4f66e308b2aae9fa70',
      'blockNumber': 711983,
      'result': null,
      'subtraces': 0,
      'traceAddress': [ 0 ],
      'transactionHash': '0xd715da4f846e41be86ea87dc97b186cafea3b50c95d5d9d889ec522b248b207f',
      'transactionPosition': 10,
      'type': 'suicide'
     };

    const timestamp = 1000000;
    const result = decodeTransferTrace(suicide_trace, timestamp, web3Wrapper);

    const result_expected = {
      'from': '0xa6c3b7f6520a0ef594fc666d3874ec78c561cdbb',
      'to': '0x245133ea0fb1b77fab5886d7ffb8046dfeff3858',
      'value': 160000000000000000,
      'valueExactBase36': '17rf9la2f4sg',
      'blockNumber': 711983,
      'timestamp': 1000000,
      'transactionHash': '0xd715da4f846e41be86ea87dc97b186cafea3b50c95d5d9d889ec522b248b207f',
      'transactionPosition': 10,
      'type': 'suicide'
    };

    assert.deepStrictEqual(result, result_expected);

  });

  it('parses trace of type call', function() {
    const call_trace= {
      'action': {
        'callType': 'call',
        'from': '0x48f2e6e5d0872da169c7f5823d5a2d5ea5f2b5e7',
        'gas': '0x34938',
        'input': '0x651e723c000000000000000000000000a9964c3a565810d09635fbc0468ec72b264cacdd000000000000000000000000000000000000000000000000000000005673dbe700000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000021bdba288b92ec8ade6739e4f75cfdc097fc8b9728bc3161e10adec84cd1cc4a160fb5c4b543de24a927ae77e9a565dfb370d8d5059e05490425efd9760351b9a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000a9964c3a565810d09635fbc0468ec72b264cacdd0000000000000000000000009abf4d7fa720ac6a3bf2b37ea746b4507b379e000000000000000000000000001d109aa4d3b7133f2b0a69c9d2848653e8649b6c000000000000000000000000491930382ca7ce1acc5a2526c08bac2709e147f6',
        'to': '0x7de5aba7de728950c92c57d08e20d4077161f12f',
        'value': '0x1'
      },
      'blockHash': '0x5e42fc42cd9f04a48713f33a9d2440079c58875f1726eab87c4ad1c55f1fc332',
      'blockNumber': 710093,
      'result': {
        'gasUsed': '0x250b6',
        'output': '0x0000000000000000000000000000000000000000000000000000000000000001'
       },
      'subtraces': 0,
      'traceAddress': [],
      'transactionHash': '0x22f839c82ff455554ec8aa98ee2b9a03d0d5ed4707b46d4a0a217df7d58bda2c',
      'transactionPosition': 10,
      'type': 'call'
    };

    const timestamp = 1450433505;

    const result = decodeTransferTrace(call_trace, timestamp, web3Wrapper);

    const result_expected = {
      'from': '0x48f2e6e5d0872da169c7f5823d5a2d5ea5f2b5e7',
      'to': '0x7de5aba7de728950c92c57d08e20d4077161f12f',
      'value': 1,
      'valueExactBase36': '1',
      'blockNumber': 710093,
      'timestamp': 1450433505,
      'transactionHash': '0x22f839c82ff455554ec8aa98ee2b9a03d0d5ed4707b46d4a0a217df7d58bda2c',
      'transactionPosition': 10,
      'type': 'call'
    };

    assert.deepStrictEqual(result, result_expected);
  });

  it('parses trace of type reward', function() {
    const reward_trace = {
      'action': {
         'author': '0x2a65aca4d5fc5b5c859090a6c34d164135398226',
         'rewardType': 'block',
         'value': '0x4563918244f40000'
       },
      'blockHash': '0x5e42fc42cd9f04a48713f33a9d2440079c58875f1726eab87c4ad1c55f1fc332',
      'blockNumber': 710093,
      'result': null,
      'subtraces': 0,
      'traceAddress': [],
      'transactionHash': null,
      'transactionPosition': null,
      'type': 'reward'
    };

    const timestamp = 1450433505;

    const result = decodeTransferTrace(reward_trace, timestamp, web3Wrapper);
    const result_expected = {
      'from': 'mining_block',
      'to': '0x2a65aca4d5fc5b5c859090a6c34d164135398226',
      'value': 5000000000000000000,
      'valueExactBase36': '11zk02pzlmwow',
      'blockNumber': 710093,
      'timestamp': 1450433505,
      'type': 'reward'
    };

    assert.deepStrictEqual(result, result_expected);
  });

  it('parses trace of type create', function() {
    const create_trace = {
     'action': {
     'from': '0x245133ea0fb1b77fab5886d7ffb8046dfeff3858',
     'gas': '0x5355d',
     'init': '0x606060405260048054600160a060020a03191630179055610451806100246000396000f3606060405260e060020a60003504632f8e042d811461003c57806360fe47b1146101025780636d4ce63c14610115578063c3da42b81461012a575b005b61003a5b6003805473ffffffffffffffffffffffffffffffffffffffff1916732faa316fc4624ec39adc2ef7b5301124cfb68777179055604080518082019091526008815260c160020a67189a969918161819026020918201908152600580546000829052915160ff19166010178155916102519160026001821615610100026000190190911604601f01047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0908101905b808211156102e457600081556001016100ee565b61003a60043560008190556101b361012e565b60005460408051918252519081900360200190f35b61003a5b6001805473ffffffffffffffffffffffffffffffffffffffff191673245133ea0fb1b77fab5886d7ffb8046dfeff38581790556000546064141561019957600154604051600160a060020a03909116906000906706f05b59d3b200009082818181858883f150505050505b6000546103e7141561024f57600154600160a060020a0316ff5b6101bb610040565b50565b50506004546706f05b59d3b20000600160a060020a0391909116311115806101e85750600054600a145b1561024f57600244064301600014156103fc57600360009054906101000a9004600160a060020a0316600160a060020a03166706f05b59d3b200006731352d32302c30326040518082815260200191505060006040518083038185876185025a03f1505050505b565b505060408051808201909152600881527f30312d30392c31370000000000000000000000000000000000000000000000006020918201908152600680546000829052915160ff19166010178155916102e89160026001821615610100026000190190911604601f01047ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f908101906100ee565b5090565b5050604080518082019091526008815260c160020a67189a969918161819026020918201908152600780546000829052915160ff19166010178155916103699160026001821615610100026000190190911604601f01047fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c688908101906100ee565b50506040805180820190915260088082527f31312d32302c3031000000000000000000000000000000000000000000000000602092830190815281546000839052905160ff1916601017825590916101be9160026001821615610100026000190190911604601f01047ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3908101906100ee565b600360009054906101000a9004600160a060020a0316600160a060020a03166706f05b59d3b200006731352d32302c30326040518082815260200191505060006040518083038185876185025a03f15050505056',
     'value': '0x14d1120d7b160000'
      },
     'blockHash': '0xdae9dcbc48275d633e2f3bb54d287c50976820e25f9e2bfba00c81047659ff4a',
     'blockNumber': 710221,
      'result': {
        'address': '0xa6c3b7f6520a0ef594fc666d3874ec78c561cdbb',
        'code': '0x606060405260e060020a60003504632f8e042d811461003c57806360fe47b1146101025780636d4ce63c14610115578063c3da42b81461012a575b005b61003a5b6003805473ffffffffffffffffffffffffffffffffffffffff1916732faa316fc4624ec39adc2ef7b5301124cfb68777179055604080518082019091526008815260c160020a67189a969918161819026020918201908152600580546000829052915160ff19166010178155916102519160026001821615610100026000190190911604601f01047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0908101905b808211156102e457600081556001016100ee565b61003a60043560008190556101b361012e565b60005460408051918252519081900360200190f35b61003a5b6001805473ffffffffffffffffffffffffffffffffffffffff191673245133ea0fb1b77fab5886d7ffb8046dfeff38581790556000546064141561019957600154604051600160a060020a03909116906000906706f05b59d3b200009082818181858883f150505050505b6000546103e7141561024f57600154600160a060020a0316ff5b6101bb610040565b50565b50506004546706f05b59d3b20000600160a060020a0391909116311115806101e85750600054600a145b1561024f57600244064301600014156103fc57600360009054906101000a9004600160a060020a0316600160a060020a03166706f05b59d3b200006731352d32302c30326040518082815260200191505060006040518083038185876185025a03f1505050505b565b505060408051808201909152600881527f30312d30392c31370000000000000000000000000000000000000000000000006020918201908152600680546000829052915160ff19166010178155916102e89160026001821615610100026000190190911604601f01047ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f908101906100ee565b5090565b5050604080518082019091526008815260c160020a67189a969918161819026020918201908152600780546000829052915160ff19166010178155916103699160026001821615610100026000190190911604601f01047fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c688908101906100ee565b50506040805180820190915260088082527f31312d32302c3031000000000000000000000000000000000000000000000000602092830190815281546000839052905160ff1916601017825590916101be9160026001821615610100026000190190911604601f01047ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3908101906100ee565b600360009054906101000a9004600160a060020a0316600160a060020a03166706f05b59d3b200006731352d32302c30326040518082815260200191505060006040518083038185876185025a03f15050505056',
        'gasUsed': '0x3aebd'
      },
      'subtraces': 0,
      'traceAddress': [],
      'transactionHash': '0x6d39df3c46f19e8ef5e8bb3b81a063a29cb352675a00d66f0dc2117a1799add1',
      'transactionPosition': 11,
      'type': 'create'
    };

    const timestamp = 1450435908;
    const result = decodeTransferTrace(create_trace, timestamp, web3Wrapper);

    const result_expected = {
      'from': '0x245133ea0fb1b77fab5886d7ffb8046dfeff3858',
      'to': '0xa6c3b7f6520a0ef594fc666d3874ec78c561cdbb',
      'value': 1500000000000000000,
      'valueExactBase36': 'be9lmezvoveo',
      'blockNumber': 710221,
      'timestamp': 1450435908,
      'transactionHash': '0x6d39df3c46f19e8ef5e8bb3b81a063a29cb352675a00d66f0dc2117a1799add1',
      'transactionPosition': 11,
      'type': 'create'
    };

    assert.deepStrictEqual(result, result_expected);
  });
});
